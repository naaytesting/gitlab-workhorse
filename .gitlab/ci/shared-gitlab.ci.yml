.workhorse:default:
  image: golang:1.14
  stage: test
  needs: []
  extends: .workhorse:rules:workhorse

workhorse:verify:
  extends: .workhorse:default
  script:
  - make -C $WORKHORSE_DIR verify

.workhorse:test:
  extends: .workhorse:default
  services:
    - name: registry.gitlab.com/gitlab-org/build/cng/gitaly:latest
      # Disable the hooks so we don't have to stub the GitLab API
      command: ["/usr/bin/env", "GITALY_TESTING_NO_GIT_HOOKS=1", "/scripts/process-wrapper"]
      alias: gitaly
  variables:
    GITALY_ADDRESS: "tcp://gitaly:8075"
  script:
  - go version
  - apt-get update && apt-get -y install libimage-exiftool-perl
  - make -C $WORKHORSE_DIR test

workhorse:test using go 1.13:
  extends: .workhorse:test
  image: golang:1.13

workhorse:test using go 1.14:
  extends: .workhorse:test
  image: golang:1.14

workhorse:test using go 1.15:
  extends: .workhorse:test
  image: golang:1.15
